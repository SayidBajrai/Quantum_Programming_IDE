<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QASM IDE - Circuit Builder</title>
    <script src="{{ url_for('static', filename='js/tailwind.min.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <!-- Monaco Editor -->
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>
</head>

<body class="bg-[#0f0f0f] text-gray-100 min-h-screen" data-theme="dark">
    <!-- Top Bar -->
    <div id="topBar" class="bg-[#1a1a1a] border-b border-gray-800 px-2 py-2">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <button id="sidebarToggleDesktop" class="hidden md:block p-0 hover:bg-gray-800 rounded-lg transition"
                    title="Toggle sidebar">
                    <svg id="sidebarToggleDesktopIcon" class="w-6 h-6" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path>
                    </svg>
                </button>
                <div id="logoIcon" class="text-2xl font-bold text-green-400">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="1"></circle>
                        <path d="M20.2 20.2c2.04-2.03.02-7.36-4.5-11.9-4.54-4.52-9.87-6.54-11.9-4.5-2.04 2.03-.02 7.36 4.5 11.9 4.54 4.52 9.87 6.54 11.9 4.5Z"></path>
                        <path d="M15.7 15.7c4.52-4.54 6.54-9.87 4.5-11.9-2.03-2.04-7.36-.02-11.9 4.5-4.52 4.54-6.54 9.87-4.5 11.9 2.03 2.04 7.36.02 11.9-4.5Z"></path>
                    </svg>
                </div>
                <h1 class="text-xl font-semibold">Quantum Programming IDE</h1>
            </div>
            <div class="flex items-center space-x-4">
                <button id="sidebarToggleMobile" class="md:hidden p-2 hover:bg-gray-800 rounded-lg transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
                <button id="themeToggle"
                    class="px-2 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition flex items-center space-x-2">
                    <span id="themeIcon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path>
                        </svg>
                    </span>
                </button>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-[auto_1fr] h-[calc(100vh-53px)]">
        <!-- Sidebar -->
        <div id="sidebar"
            class="w-64 bg-[#1a1a1a] border-r border-gray-800 p-4 transition-all duration-300 overflow-hidden">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-sm font-semibold text-gray-300">Menu</h2>
            </div>

            <nav class="space-y-2">
                <a href="/home" class="nav-item w-full text-left px-4 py-2 rounded-lg hover:bg-gray-800 transition flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                    <span>Home</span>
                </a>
                <a href="/compiler" class="nav-item w-full text-left px-4 py-2 rounded-lg hover:bg-gray-800 transition flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18 16 4-4-4-4"></path><path d="m6 8-4 4 4 4"></path><path d="m14.5 4-5 16"></path></svg>
                    <span>Compiler</span>
                </a>
                <button class="nav-item active w-full text-left px-4 py-2 rounded-lg bg-gray-800 text-gray-900 flex items-left space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                        <line x1="8" y1="21" x2="16" y2="21"></line>
                        <line x1="12" y1="17" x2="12" y2="21"></line>
                    </svg>
                    <span>Circuit Builder</span>
                </button>
            </nav>

            <div class="mt-8">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-sm font-semibold text-gray-400">Gate Palette</h3>
                </div>
                <div id="gatePalette" class="space-y-2">
                    <!-- Gate buttons will be generated dynamically -->
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex flex-col min-w-0 h-full">
            <!-- Circuit Builder and Code Editor Section -->
            <div id="editorSection" class="flex gap-0" style="height: 60%; min-height: 300px;">
                <!-- Circuit Builder Section (LEFT) -->
                <div id="circuitBuilderSection" class="flex flex-col" style="width: 50%; min-width: 200px;">
                    <div class="mb-0 flex items-center justify-between p-4">
                        <div class="flex items-center space-x-2">
                            <h2 class="text-lg font-semibold">Circuit Builder</h2>
                            <button id="clearCircuitBtn"
                                class="px-3 py-0 bg-gray-800 hover:bg-gray-700 rounded-lg font-semibold transition text-gray-100"
                                title="Clear Circuit">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M3 6h18"></path>
                                    <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                                    <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                                </svg>
                            </button>
                            <button id="addQubitBtn"
                                class="px-3 py-1 bg-green-600 hover:bg-green-700 rounded-lg font-semibold transition text-gray-100 text-sm"
                                title="Add Qubit">
                                + Qubit
                            </button>
                            <button id="removeQubitBtn"
                                class="px-3 py-1 bg-red-600 hover:bg-red-700 rounded-lg font-semibold transition text-gray-100 text-sm"
                                title="Remove Qubit">
                                - Qubit
                            </button>
                        </div>
                        <div id="circuitStatus" class="text-sm text-gray-400">
                            Ready
                        </div>
                    </div>

                    <div id="circuitBuilderContainer"
                        class="flex-1 border border-gray-800 rounded-lg overflow-auto bg-black p-4">
                        <div id="circuitBuilder" class="min-h-full">
                            <!-- Circuit will be rendered here -->
                        </div>
                    </div>
                </div>

                <!-- Horizontal Resize Handle -->
                <div id="horizontalResizeHandle"
                    class="w-2 bg-gray-800 hover:bg-gray-700 cursor-col-resize transition-colors flex items-center justify-center group">
                    <div class="h-24 w-1 bg-gray-600 group-hover:bg-gray-500 rounded-full transition-colors"></div>
                </div>

                <!-- Code Editor Section (RIGHT, non-editable) -->
                <div id="codeEditorSection" class="flex flex-col" style="width: 50%; min-width: 200px;">
                    <div class="mb-0 flex items-center justify-between p-4">
                        <h2 class="text-lg font-semibold">Generated QASM Code</h2>
                        <div class="flex items-center space-x-4">
                            <label class="flex items-center space-x-2">
                                <span class="text-sm text-gray-400">Shots:</span>
                                <input type="number" id="shotsInput" value="1024" min="1" max="100000"
                                    class="w-24 px-3 py-0 bg-gray-800 border border-gray-700 rounded text-sm">
                            </label>
                            <button id="saveBtn"
                                class="px-3 py-0 bg-gray-800 hover:bg-gray-700 rounded-lg font-semibold transition text-gray-100">
                                <svg id="saveBtnIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"></path><path d="M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7"></path><path d="M7 3v4a1 1 0 0 0 1 1h7"></path></svg>
                            </button>
                            <button id="runBtn"
                                class="px-3 py-0 bg-gray-800 hover:bg-gray-700 rounded-lg font-semibold transition text-gray-100">
                                <svg id="runBtnIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="6 3 20 12 6 21 6 3"></polygon></svg>
                            </button>
                        </div>
                    </div>

                    <div
                        class="flex-1 border border-gray-800 rounded-lg overflow-hidden bg-black theme-editor-container">
                        <div id="codeEditor" style="width: 100%; height: 100%;"></div>
                    </div>
                </div>
            </div>

            <!-- Resize Handle -->
            <div id="resizeHandle"
                class="h-2 bg-gray-800 hover:bg-gray-700 cursor-row-resize transition-colors flex items-center justify-center group">
                <div class="w-24 h-1 bg-gray-600 group-hover:bg-gray-500 rounded-full transition-colors"></div>
            </div>

            <!-- Output Section -->
            <div id="outputSection" class="border-t border-gray-800 bg-[#1a1a1a] p-4 theme-output overflow-auto">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold">Simulation Results</h2>
                    <div id="statusIndicator" class="text-sm text-gray-400">
                        Ready
                    </div>
                </div>

                <!-- Error Display -->
                <div id="errorDisplay" class="hidden mb-4 p-4 bg-red-900/30 border border-red-700 rounded-lg">
                    <div class="font-semibold text-red-400 mb-2">Error</div>
                    <div id="errorMessage" class="text-sm text-red-300"></div>
                </div>

                <!-- Results Display -->
                <div id="resultsDisplay" class="hidden">
                    <div class="mb-4 text-sm text-gray-400">
                        <span id="qubitsInfo"></span> |
                        <span id="shotsInfo"></span>
                    </div>

                    <!-- Histogram -->
                    <div class="mb-4">
                        <canvas id="histogramCanvas" class="w-full h-48 bg-gray-900 rounded"></canvas>
                    </div>

                    <!-- Counts Table -->
                    <div>
                        <table id="countsTable" class="w-full text-sm">
                            <thead class="bg-gray-800 sticky top-0">
                                <tr>
                                    <th class="px-4 py-2 text-left">State</th>
                                    <th class="px-4 py-2 text-left">Dirac Notation</th>
                                    <th class="px-4 py-2 text-left">Count</th>
                                    <th class="px-4 py-2 text-left">Probability</th>
                                </tr>
                            </thead>
                            <tbody id="countsTableBody" class="text-gray-300">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="text-center text-gray-500 py-12">
                    <div id="emptyStateIcon" class="text-4xl mb-2 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="1"></circle>
                            <path d="M20.2 20.2c2.04-2.03.02-7.36-4.5-11.9-4.54-4.52-9.87-6.54-11.9-4.5-2.04 2.03-.02 7.36 4.5 11.9 4.54 4.52 9.87 6.54 11.9 4.5Z"></path>
                            <path d="M15.7 15.7c4.52-4.54 6.54-9.87 4.5-11.9-2.03-2.04-7.36-.02-11.9 4.5-4.52 4.54-6.54 9.87-4.5 11.9 2.03 2.04 7.36.02 11.9-4.5Z"></path>
                        </svg>
                    </div>
                    <div>Run a simulation to see results here</div>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script src="{{ url_for('static', filename='js/circuit-builder.js') }}"></script>
    <script>
        // Theme management for circuit page
        function applyCircuitTheme(theme) {
            const isDark = theme === 'dark';
            const config = themeConfig[theme];
            
            // Apply base theme
            applyTheme(theme);
            
            // Update circuit builder container
            const circuitBuilderContainer = document.getElementById('circuitBuilderContainer');
            if (circuitBuilderContainer) {
                circuitBuilderContainer.className = circuitBuilderContainer.className.replace(/bg-black|bg-white/g, config.codeEditor.bg);
                circuitBuilderContainer.className = circuitBuilderContainer.className.replace(/border-gray-800|border-gray-300/g, config.codeEditor.border);
            }
            
            // Update buttons
            const buttons = document.querySelectorAll('#clearCircuitBtn, #addQubitBtn, #removeQubitBtn, #saveBtn, #runBtn');
            buttons.forEach(btn => {
                if (btn.id === 'addQubitBtn' || btn.id === 'removeQubitBtn') {
                    // Green/red buttons - keep their colors but update text
                    btn.className = btn.className.replace(/text-gray-100|text-gray-900/g, 'text-white');
                } else {
                    // Gray buttons
                    btn.className = btn.className.replace(/bg-gray-800|bg-gray-200/g, isDark ? 'bg-gray-800' : 'bg-gray-200');
                    btn.className = btn.className.replace(/hover:bg-gray-700|hover:bg-gray-300/g, isDark ? 'hover:bg-gray-700' : 'hover:bg-gray-300');
                    btn.className = btn.className.replace(/text-gray-100|text-gray-900/g, isDark ? 'text-gray-100' : 'text-gray-900');
                }
            });
            
            // Update input fields
            const inputs = document.querySelectorAll('#shotsInput');
            inputs.forEach(input => {
                input.className = input.className.replace(/bg-gray-800|bg-white/g, config.input.bg);
                input.className = input.className.replace(/border-gray-700|border-gray-300/g, config.input.border);
                input.className = input.className.replace(/text-gray-100|text-gray-900/g, config.input.text);
            });
            
            // Update resize handles
            const resizeHandles = document.querySelectorAll('#horizontalResizeHandle, #resizeHandle');
            resizeHandles.forEach(handle => {
                handle.className = handle.className.replace(/bg-gray-800|bg-gray-200/g, isDark ? 'bg-gray-800' : 'bg-gray-200');
                handle.className = handle.className.replace(/hover:bg-gray-700|hover:bg-gray-300/g, isDark ? 'hover:bg-gray-700' : 'hover:bg-gray-300');
                const inner = handle.querySelector('div');
                if (inner) {
                    inner.className = inner.className.replace(/bg-gray-600|bg-gray-400/g, isDark ? 'bg-gray-600' : 'bg-gray-400');
                }
            });
            
            // Update status text
            const statusTexts = document.querySelectorAll('#circuitStatus, #statusIndicator');
            statusTexts.forEach(text => {
                text.className = text.className.replace(/text-gray-400|text-gray-600/g, isDark ? 'text-gray-400' : 'text-gray-600');
            });
            
            // Update table
            const table = document.getElementById('countsTable');
            if (table) {
                const thead = table.querySelector('thead');
                if (thead) {
                    thead.className = thead.className.replace(/bg-gray-800|bg-gray-200/g, config.table.bg);
                }
                const tbody = table.querySelector('tbody');
                if (tbody) {
                    tbody.className = tbody.className.replace(/text-gray-300|text-gray-700/g, config.table.text);
                }
            }
            
            // Update canvas background
            const canvas = document.getElementById('histogramCanvas');
            if (canvas) {
                canvas.className = canvas.className.replace(/bg-gray-900|bg-gray-100/g, isDark ? 'bg-gray-900' : 'bg-gray-100');
            }
            
            // Update Monaco editor theme if it exists
            if (typeof window.circuitBuilderMonacoEditor !== 'undefined' && window.circuitBuilderMonacoEditor) {
                updateMonacoEditorTheme(isDark);
                window.circuitBuilderMonacoEditor.updateOptions({ theme: 'openqasm-theme' });
            }
            
            // Update gatePalette buttons
            if (typeof updateGatePaletteTheme === 'function') {
                updateGatePaletteTheme(isDark);
            }
            
            // Update sidebar toggle buttons
            const sidebarToggleDesktop = document.getElementById('sidebarToggleDesktop');
            const sidebarToggleMobile = document.getElementById('sidebarToggleMobile');
            if (sidebarToggleDesktop) {
                sidebarToggleDesktop.className = sidebarToggleDesktop.className.replace(/hover:bg-gray-800|hover:bg-gray-200/g, isDark ? 'hover:bg-gray-800' : 'hover:bg-gray-200');
            }
            if (sidebarToggleMobile) {
                sidebarToggleMobile.className = sidebarToggleMobile.className.replace(/hover:bg-gray-800|hover:bg-gray-200/g, isDark ? 'hover:bg-gray-800' : 'hover:bg-gray-200');
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize theme icon
            initializeThemeIcon();
            
            // Load and apply theme
            const theme = localStorage.getItem('theme') || 'dark';
            applyCircuitTheme(theme);
            
            // Setup theme toggle
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', () => {
                    toggleTheme();
                    const newTheme = localStorage.getItem('theme') || 'dark';
                    applyCircuitTheme(newTheme);
                });
            }
            
            // Setup sidebar toggle
            const sidebarToggleDesktop = document.getElementById('sidebarToggleDesktop');
            const sidebarToggleMobile = document.getElementById('sidebarToggleMobile');
            if (sidebarToggleDesktop) {
                sidebarToggleDesktop.addEventListener('click', toggleSidebar);
            }
            if (sidebarToggleMobile) {
                sidebarToggleMobile.addEventListener('click', toggleSidebar);
            }
            
            // Load sidebar state
            loadSidebarState();
        });
    </script>
</body>

</html>